<!DOCTYPE html>

<html>

<title>
  This is a title.
</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.js"></script>
<script src="graph.js"></script>
<script src="files.js"></script>
<script>

var firstInit = true;

var GLOBAL_response;
var HttpClient = function() {
  this.get = function(aUrl){
    var anHttpRequest = new XMLHttpRequest();
    anHttpRequest.onreadystatechange = function() {
      if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
          console.log("Response Text",anHttpRequest.responseText);
          GLOBAL_response = anHttpRequest.responseText;
          return(anHttpRequest.responseText);
    }

    anHttpRequest.open( "GET",aUrl, true );
    anHttpRequest.send( null );
  }
}


var tempJson = {"points": [{"env_brightness":1700,"led_brightness":100},{"env_brightness":800,"led_brightness":80},{"env_brightness":100,"led_brightness":10}]};

var client = new HttpClient();

var populateData = function(addr){
  var my_data = JSON.parse(GLOBAL_response);
  client.get(addr);
  for (var i = 0; i < my_data.length; i++) {
    var y = map(mydata[i].led_brightness,0,100,0,1);
    var x = map(mydata[i].env_brightness,0,100,1,0);
    temp_point = createVector(x,y);
    console.log("Adding a new point: ",x,y);
    new_point(temp_point,GLOBAL_data);
  }
};

var customParse = function (mystring){
  var newString = "";
  for (var i = 0; i < mystring.length; i++) {
    //console.log(mystring[i]=="'");
    if (mystring[i]=="'") {
      newString = newString.concat("\"");
    } else {
      newString = newString.concat(mystring[i]);
    }
  }
  return(newString);
}

var sendNewData = function(data){
  //first, convert GLOBAL_data to JSON
  var temporary = [];
  for (var i = 0; i < data.length; i++) {
    datavalue = {
              "env_brightness":data[i].x,
              "led_brightness":data[i].y
            };
    temporary.push(datavalue);
  }
}

window.setInterval(function(){
  if (firstInit) {
    GLOBAL_updating = true;
    console.log("Initial get request");
    fileReader('http://localhost:8000');
    firstInit = false;
    console.log(GLOBAL_response);
    GLOBAL_updating = false;
  }
  //console.log(GLOBAL_data);
  console.log(GLOBAL_response);
  sendToServer('http://localhost:8000',dataToJSON(GLOBAL_data));
  GLOBAL_updating = true;
  fileReader('http://localhost:8000');
  GLOBAL_updating = false;

},10000);

var fileReader = function(path){
  readfile = new XMLHttpRequest();
  readfile.open('GET',path,true);
  readfile.onload = function() {
    GLOBAL_updating = true;
    if (readfile.status >=200 && readfile.status < 400) {
      console.log(readfile.responseText);
      var newText = JSON.parse(customParse(readfile.responseText));
      for (var i = 0; i < newText.length; i++) {
        var x = map(newText[i].env_brightness,0,100,1,0);
        var y = map(newText[i].led_brightness,0,100,0,1);
        readPoint = createVector(x,y);
        console.log("Adding point!");
        new_point(readPoint,GLOBAL_data);
      }
    }
    GLOBAL_updating= false;
  }
  readfile.onerror = function() {
    console.log("A problem arose...");
  }
  readfile.send();
}

var fileWriter = function(path,data){
  var csv_string = "";
  for (var i = 0; i < data.length; i++) {
    var x = map(data[i].x,1,0,0,100);
    var y = map(data[i].y,0,1,0,100);
    csv_string = csv_string + x + "," + y + "\n"
  }
  //console.log(csv_string);
  return;
  writefile = new XMLHttpRequest();
  writefile.open('POST','../data.csv',true)
  writefile.onload = function(){
    console.log("Wrote to file");
  }
  writefile.onerror = function(){
    console.log("Could not write to file");
  }
  writefile.send(csv_string);
}

</script>

<style>
/*
.graph {
  background-color: Tomato;
  color: Blue;
  height: 200px;
  width: 300px;
  margin-left: 20px;
  margin-top: 20px;
} */

</style>

<head>
</head>

<body>
  <!-- <div class="graph">

  </div> -->


</body>

</html>
